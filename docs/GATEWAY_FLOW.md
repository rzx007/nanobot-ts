# Nanobot Gateway 模式调用流程图

## 1. 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Gateway 模式启动流程                                  │
└─────────────────────────────────────────────────────────────────────────────────────┘
┌──────────────┐
│   CLI入口    │
│   cmdGateway │
└──────┬───────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              初始化阶段                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  1. 加载配置 (loadConfig)                                                           │
│  2. 创建 MessageBus (消息总线)                                                     │
│  3. 初始化 SessionManager (会话管理)                                               │
│  4. 创建 LLMProvider (LLM提供者)                                                   │
│  5. 初始化 ToolRegistry (工具注册表)                                               │
│  6. 创建 ApprovalManager (审批管理器)                                               │
│     - 解析 approval 配置 (ApprovalConfigSchema.parse)                             │
│     - 创建 ApprovalMemory (审批记忆管理)                                            │
│     - 设置审批检查器到 ToolRegistry: tools.setApprovalCheck(approvalManager)      │
│  7. 注册默认审批处理器:                                                             │
│     - initializeDefaultHandlers(bus)                                              │
│     - 注册 CLIApprovalHandler (CLI渠道)                                            │
│     - 注册 MessageApprovalHandler (消息渠道)                                        │
│  8. 设置消息过滤器:                                                                 │
│     - MessageBus.addInboundFilter() 拦截入站消息                                    │
│     - 回调: approvalManager.handleUserMessage()                                    │
│  9. 注册所有内置工具:                                                               │
│     - ReadFileTool, WriteFileTool, EditFileTool, DeleteFileTool                    │
│     - ListDirTool, ExecTool                                                        │
│     - WebSearchTool, WebFetchTool                                                  │
│     - MessageTool, SpawnTool, CronTool                                            │
│ 10. 加载 MCP 工具:                                                                 │
│     - 创建 MCPToolLoader                                                           │
│     - 加载 MCP 配置 (workspace/mcp.json)                                          │
│     - 连接所有 MCP 服务器 (stdio/http)                                             │
│     - 包装 MCP 工具并注册到 ToolRegistry                                           │
│ 11. 启动 CronService (定时任务服务)                                                │
│ 12. 初始化 MemoryConsolidator (记忆整合器)                                         │
│ 13. 初始化 SkillLoader (技能加载器)                                               │
│ 14. 创建 AgentLoop (Agent主循环)                                                   │
│ 15. 初始化 ChannelManager (渠道管理器)                                             │
│ 16. 注册 CLIChannel                                                                 │
│ 17. 加载配置中的渠道 (WhatsApp, Feishu, Email)                                    │
│ 18. 启动所有渠道                                                                    │
│ 19. 启动出站消费循环 (runOutboundLoop)                                             │
│ 20. 启动 Agent 主循环 (agent.run())                                                │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 2. 消息处理流程图

```

┌─────────────────────────────────────────────────────────────────────────────┐
│                           入站消息处理流程                                 │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────┐                                 ┌────────────────────────────────┐
│ 用户输入 │───────────────────────────────▶│         MessageBus             │
│  (CLI)   │                                │    publishInbound(msg)         │
└──────────┘                                └──────────┬─────────────────────┘
                                                     │
                                             [添加到队列]
                                                     │
                                                     ▼
                                      ┌──────────────────────────────┐
                                      │   inboundQueue: InboundMessage[]   │
                                      └──────────┬─────────────────────┘
                                                 │
                                         触发 'inbound' 事件
                                                 │
                                                 ▼
                                      ┌──────────────────────────────┐
                                      │        有消费者?             │
                                      └──────────┬─────────────────────┘
                                                 │
                                    ┌───────────┴───────────┐
                                    │                      │
                                    ▼                      │
                          ┌──────────────────────┐         │
                          │  消费者获取消息      │         │
                          └──────────┬───────────┘         │
                                     │                     │
                                     ▼                     │
                            ┌──────────────────────────────┐
                            │        AgentLoop             │
                            │        run() 主循环          │
                            └──────────┬───────────────────┘
                                       │
                                       ▼
                      ┌───────────────────────────────────────┐
                      │        consumeInbound()               │
                      │        (阻塞直到有消息)               │
                      └──────────┬───────────────────────────┘
                                 │
                                 ▼
                ┌───────────────────────────────────────────┐
                │           _processMessage(msg)            │
                └──────────┬───────────────────────────────┘
                           │
  ┌────────────────────────┴────────────────────────┐
  │                                                │
  ▼                                                │
┌──────────────────────────────────────────────┐   │
│ 步骤1: 检查会话命令                          │   │
│ - /new: 开启新会话                           │   │
│ - /help: 显示帮助                            │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
┌──────────────────────────────────────────────┐   │
│ 步骤2: 为需要上下文的工具设置 channel/chatId │   │
│ - spawn, cron 等工具需要知道消息来源        │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
┌──────────────────────────────────────────────┐   │
│ 步骤3: 添加用户消息到会话                    │   │
│ SessionManager.addMessage()                  │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
┌──────────────────────────────────────────────┐   │
│ 步骤4: 获取会话历史                          │   │
│ SessionManager.getHistory(memoryWindow)      │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
┌──────────────────────────────────────────────┐   │
│ 步骤5: 构建系统提示词                        │   │
│ - Identity: 机器人身份                       │   │
│ - Bootstrap: 初始化指令                      │   │
│ - Memory: 长期记忆                           │   │
│ - Skills: 可用技能列表                       │   │
│ ContextBuilder.buildSystemPrompt()           │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
┌──────────────────────────────────────────────┐   │
│ 步骤6: 构建消息列表                          │   │
│ ContextBuilder.buildMessages()               │   │
│ - 系统提示词                                 │   │
│ - 历史消息                                  │   │
│ - 当前消息                                  │   │
│ - 运行时上下文注入                          │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
┌──────────────────────────────────────────────┐   │
│ 步骤7: 获取工具定义                          │   │
│ ToolRegistry.getDefinitions()                │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
┌──────────────────────────────────────────────┐   │
│ 步骤8: 调用 LLM (Vercel AI SDK)              │   │
│ LLMProvider.chat({                           │   │
│ messages, tools, model,                      │   │
│ temperature, maxTokens,                      │   │
│ maxSteps, executeTool                        │   │
│ })                                           │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
┌──────────────────────────────────────────────┐   │
│ 步骤9: LLM 多步执行循环 (如果需要工具)      │   │
│ ├─ 第1步: LLM 返回文本/工具调用             │   │
│ ├─ 第2步: 如果是工具调用                     │   │
│ │ ├─ 执行工具: executeTool(name, args)      │   │
│ │ └─ ToolRegistry.execute()                  │   │
│ │ ├─ ReadFileTool                           │   │
│ │ ├─ WriteFileTool                          │   │
│ │ ├─ EditFileTool                           │   │
│ │ ├─ ListDirTool                            │   │
│ │ ├─ ExecTool                               │   │
│ │ ├─ WebSearchTool                          │   │
│ │ ├─ WebFetchTool                           │   │
│ │ ├─ MessageTool (发送消息)                  │   │
│ │ ├─ SpawnTool (生成任务)                    │   │
│ │ └─ CronTool (定时任务)                    │   │
│ └─ 第3步: 返回工具结果给 LLM                │   │
│ ├─ 重复直到达到 maxSteps 或无工具调用       │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
┌──────────────────────────────────────────────┐   │
│ 步骤10: 处理 LLM 响应                        │   │
│ - 去除  标签内容                      │   │
│ - 添加助手消息到会话                         │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
┌──────────────────────────────────────────────┐   │
│ 步骤11: 记忆整合 (如果需要)                   │   │
│ MemoryConsolidator.needsConsolidation()      │   │
│ ├─ 如果超过阈值:                             │   │
│ │ ├─ consolidate(session)                    │   │
│ │ ├─ 提取重要信息到长期记忆                  │   │
│ │ ├─ 归档旧消息                              │   │
│ │ └─ 更新 lastConsolidated                   │   │
│ └─ 保存会话                                 │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
┌──────────────────────────────────────────────┐   │
│ 步骤12: 返回 OutboundMessage                 │   │
│ { channel, chatId, content }                 │   │
└──────────┬────────────────────────────────────┘   │
           │                                        │
           ▼                                        │
  ┌──────────────────────────────────────────┐     │
  │              MessageBus                  │     │
  │         publishOutbound(msg)             │     │
  └──────────┬──────────────────────────────┘     │
             │                                    │
             ▼                                    │
┌──────────────────────────────────────────┐     │
│     outboundQueue: OutboundMessage[]     │     │
└──────────┬──────────────────────────────┘     │
           │                                    │
           ▼                                    │
 ┌─────────────────────────────────────────┐   │
 │            ChannelManager               │   │
 │          runOutboundLoop()              │   │
 └──────────┬──────────────────────────────┘   │
            │                                  │
            ▼                                  │
┌──────────────────────────────────────────┐   │
│        consumeOutbound()                 │   │
│      (阻塞直到有消息)                   │   │
└──────────┬──────────────────────────────┘   │
           │                                  │
           ▼                                  │
┌──────────────────────────────────────────┐   │
│        根据 channel 分发消息              │   │
│        channel.send(msg)                  │   │
└──────────┬──────────────────────────────┘   │
           │                                  │
   ┌───────┴───────┬────────────┬────────────┘
   │               │            │
   ▼               ▼            ▼
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│CLIChannel│  │WhatsAppChannel│  │FeishuChannel│  │EmailChannel│
│ 发送到   │  │ 发送到   │  │ 发送到   │  │ 发送到   │
│   终端   │  │WhatsApp  │  │   飞书   │  │   邮箱   │
└──────────┘  └──────────┘  └──────────┘  └──────────┘

```

## 3. 定时任务 (Cron) 消息流程

```

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          定时任务消息流程                                             │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐
│ CronService  │
│  定时器触发  │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────────────┐
│  执行任务回调                       │
│  onJob(job)                        │
│  ├─ 从 payload 读取:               │
│  │   - channel: 目标渠道           │
│  │   - to: 目标聊天ID              │
│  │   - message: 消息内容            │
└──────┬──────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│  MessageBus.publishInbound({       │
│    channel: 'cli' | 'whatsapp'... │
│    senderId: 'cron'                │
│    chatId: 'direct' | 具体ID        │
│    content: job.payload.message     │
│    timestamp: new Date()           │
│  })                                │
└──────┬──────────────────────────────┘
       │
       │ [后续流程与用户输入相同]
       ▼
┌─────────────────────────────────────┐
│  AgentLoop 处理定时任务消息           │
│  [执行完整的 Agent 处理流程]         │
└─────────────────────────────────────┘
```

## 4. 多渠道并行处理流程

```

┌─────────────────────────────────────────────────────────────────────────────┐
│                           多渠道并行处理架构                                 │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                                 用户层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐              │
│  │ CLI 终端 │    │ WhatsApp │    │   飞书   │    │   邮箱   │              │
│  └─────┬─────┘    └─────┬─────┘    └─────┬─────┘    └─────┬─────┘              │
│        │              │              │              │                    │
└─────────┼──────────────┼──────────────┼──────────────┼─────────────────────┘
          │              │              │              │
          ▼              ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 渠道层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌──────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │ CLIChannel  │    │WhatsAppChannel│    │FeishuChannel│    │ EmailChannel│  │
│  │  (内置)     │    │   (可选)     │    │   (可选)    │    │   (可选)    │  │
│  └──────┬──────┘    └──────┬───────┘    └──────┬──────┘    └──────┬──────┘  │
│         │                 │                │                │               │
│         │  入站消息        │  入站消息       │  入站消息       │  入站消息      │
│         ▼                 ▼                ▼                ▼               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          MessageBus                                 │   │
│  │                     publishInbound(msg)                             │   │
│  │                      (统一的消息队列)                               │   │
│  └────────────────────────────────┬────────────────────────────────────┘   │
└────────────────────────────────────┼─────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 处理层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                                AgentLoop                                  │ │
│  │                               run() 主循环                                │ │
│  │                                                                           │ │
│  │                               消费入站消息                                 │ │
│  │  ├─ 会话管理 (SessionManager)                                            │ │
│  │  ├─ 记忆管理 (MemoryConsolidator)                                        │ │
│  │  ├─ 技能管理 (SkillLoader)                                               │ │
│  │  ├─ LLM 调用 (LLMProvider)                                               │ │
│  │  └─ 工具执行 (ToolRegistry)                                              │ │
│  │    ├─ 文件操作 (Read/Write/Edit/List)                                     │ │
│  │    ├─ Shell 命令 (Exec)                                                  │ │
│  │    ├─ Web 请求 (Search/Fetch)                                            │ │
│  │    ├─ 消息发送 (Message)                                                 │ │
│  │    ├─ 任务生成 (Spawn)                                                   │ │
│  │    └─ 定时任务 (Cron)                                                    │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│                                     │                                       │
│                                     ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                          MessageBus                                       │ │
│  │                     publishOutbound(msg)                                  │ │
│  └────────────────────────────────┬──────────────────────────────────────────┘ │
└────────────────────────────────────┼─────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 分发层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                           ChannelManager                                  │ │
│  │                         runOutboundLoop()                                 │ │
│  │                                                                           │ │
│  │                               消费出站消息                                 │ │
│  │                   └─ 根据 channel 字段分发到对应的渠道                    │ │
│  │                     ├─ 'cli' → CLIChannel                                │ │
│  │                     ├─ 'whatsapp' → WhatsAppChannel                      │ │
│  │                     ├─ 'feishu' → FeishuChannel                          │ │
│  │                     └─ 'email' → EmailChannel                            │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└────────────────────────────────┬─────────────────────────────────────────────┘
                                 │
         ┌────────────────────────┼────────────────────────┐
         │                        │                        │
         ▼                        ▼                        ▼
┌──────────┐                ┌──────────┐                ┌──────────┐
│CLIChannel│                │WhatsAppChannel│           │FeishuChannel│
│ send(msg)│                │ send(msg)│                │ send(msg)│
└──────────┘                └──────────┘                └──────────┘
    │                          │                          │
    ▼                          ▼                          ▼
┌──────────┐                ┌──────────┐                ┌──────────┐
│ CLI 终端 │                │ WhatsApp │                │   飞书   │
│ 输出响应 │                │ 发送消息 │                │ 发送消息 │
└──────────┘                └──────────┘                └──────────┘

```

## 5. 工具执行详细流程

```

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         工具执行详细流程                                               │
└─────────────────────────────────────────────────────────────────────────────────────┘

AgentLoop._processMessage() 调用 LLMProvider.chat()
                                          │
                                          ▼
                           ┌───────────────────────────────┐
                           │ LLM 返回工具调用请求           │
                           │ {                           │
                           │   toolCalls: [               │
                           │     {                        │
                           │       name: 'read_file',     │
                           │       args: { path: '...' }  │
                           │     }                        │
                           │   ]                         │
                           │ }                           │
                           └───────────────┬─────────────┘
                            │
                            ▼
                            ┌───────────────────────────────┐
                            │ executeTool(name, args)       │
                            │ (由 Vercel AI SDK 自动调用)    │
                            └───────────────┬─────────────┘
                                            │
                                            ▼
                            ┌───────────────────────────────┐
                            │ ToolRegistry.execute()        │
                            ├───────────────────────────────┤
                            │ 步骤1: 查找工具               │
                            │ const tool = this.tools[name] │
                            └───────────────┬─────────────┘
                                            │
                                            ▼
                            ┌───────────────────────────────┐
                            │ 步骤2: 验证参数               │
                            │ tool.validateParams(params)   │
                            └───────────────┬─────────────┘
                                            │
                                            ▼
                            ┌───────────────────────────────┐
                            │ 步骤3: 检查是否需要审批       │
                            │ approvalCheck.needsApproval(  │
                            │   toolName, params,           │
                            │   toolRiskLevel,              │
                            │   channel, chatId            │
                            │ )                             │
                            ├───────────────────────────────┤
                            │ 审批判断逻辑:                  │
                            │ 1. 检查全局开关 enabled      │
                            │ 2. 检查工具级别覆盖          │
                            │    toolOverrides[name]        │
                            │ 3. 获取工具风险级别          │
                            │    HIGH → 总是需要            │
                            │    MEDIUM → 检查记忆          │
                            │    LOW → 无需审批             │
                            │ 4. 严格模式 strictMode       │
                            │    所有非LOW都需要审批        │
                            └───────────────┬─────────────┘
                                            │
                                ┌───────────┴───────────┐
                                │                       │
                                ▼                       │
                    ┌───────────────────────┐           │
                    │ 需要审批?              │           │
                    │ requestApproval()      │           │
                    └───────────┬───────────┘           │
                                │                       │
                                ▼                       │
                ┌───────────────────────────────┐       │
                │ ApprovalManager              │       │
                ├───────────────────────────────┤       │
                │ 1. 获取渠道处理器             │       │
                │    getHandler(channel)        │       │
                │    ├─ CLI → CLIApprovalHandler│       │
                │    └─ 其他 → MessageApprovalHandler│   │
                │ 2. 发送审批请求               │       │
                │    handler.requestConfirmation│
                │    通过渠道发送消息给用户      │
                │ 3. 等待用户回复               │       │
                │    yes/no 或确认/拒绝         │       │
                │ 4. 记录审批决策               │       │
                │    Memory.recordApproval()    │       │
                └───────────┬───────────────────┘       │
                            │                           │
                    ┌───────┴───────┐                   │
                    │               │                   │
                    ▼               ▼                   │
            ┌──────────────┐  ┌──────────────┐           │
            │ 用户批准     │  │ 用户拒绝     │           │
            └──────┬───────┘  └──────┬───────┘           │
                   │                 │                   │
                   ▼                 │                   │
            ┌──────────────┐          │                   │
            │ 记录到记忆    │          │                   │
            │ 继续执行      │          │                   │
            └──────┬───────┘          │                   │
                   │                  │                   │
                   ▼                  ▼                   │
                   └──────────┬───────┘                   │
                              │                           │
                              ▼                           │
                            ┌───────────────────────────────┐
                            │ 步骤4: 执行工具              │
                            │ tool.execute(params)         │
                                           │
              ┌────────────────────────────┼────────────────────────────┐
              │                            │                            │
              ▼                            ▼                            ▼
    ┌─────────────────┐          ┌─────────────────┐          ┌─────────────────┐
    │ 文件系统工具      │          │  Shell工具      │          │  Web工具         │
    │                 │          │                 │          │                 │
    │ 1. ReadFileTool │          │ 1. ExecTool     │          │ 1. WebSearchTool│
    │    读取文件内容   │          │    执行命令       │          │    搜索网页       │
    │                 │          │                 │          │                 │
    │ 2. WriteFileTool│          │                 │          │ 2. WebFetchTool │
    │    写入文件内容   │          │                 │          │    获取网页内容    │
    │                 │          │                 │          │                 │
    │ 3. EditFileTool │          │                 │          └────────┬────────┘
    │    编辑文件       │          │                 │                   │
    │                 │          │                 │                   │
     │ 4. DeleteFileTool│          │                 │                   │
     │    删除文件       │          │                 │                   │
     │                 │          │                 │                   │
     │ 5. ListDirTool  │          │                 │                   │
     │    列出目录       │          │                 │                   │
     └────────┬────────┘          └────────┬────────┘                   │
              │                            │                            │
              │                            │                            │
              ▼                            ▼                            ▼
 ┌─────────────────────────────────────────────────────────────────────────────────────┐
 │                           MCP 工具 (外部服务器)                                      │
 ├─────────────────────────────────────────────────────────────────────────────────────┤
 │                                                                                     │
 │   MCP (Model Context Protocol) 工具是从外部服务器动态加载的工具:                  │
 │                                                                                     │
 │   ┌─────────────────────────────┐  ┌─────────────────────────────┐                │
 │   │ stdio MCP 服务器            │  │ http MCP 服务器             │                │
 │   ├─────────────────────────────┤  ├─────────────────────────────┤                │
 │   │ • 通过子进程通信            │  │ • 通过 HTTP REST API 通信   │                │
 │   │ • 命令: node, python, java │  │ • 支持标准 HTTP 方法        │                │
 │   │ • 环境变量: env            │  │ • 支持 OAuth 2.0 认证       │                │
 │   │ • 工作目录: cwd            │  │ • Token 端点认证           │                │
 │   └─────────────────────────────┘  └─────────────────────────────┘                │
 │                                                                                     │
 │   配置文件: workspace/mcp.json                                                     │
 │   {                                                                                 │
 │     "enabled": true,                                                               │
 │     "servers": [                                                                   │
 │       {                                                                             │
 │         "name": "filesystem",                                                      │
 │         "type": "stdio",                                                           │
 │         "stdio": {                                                                  │
 │           "command": "npx",                                                        │
 │           "args": ["-y", "@modelcontextprotocol/server-filesystem"],              │
 │           "env": {                                                                 │
 │             "FILESYSTEM_ALLOWED_DIRECTORIES": "/workspace"                         │
 │           }                                                                        │
 │         }                                                                          │
 │       },                                                                            │
 │       {                                                                             │
 │         "name": "custom",                                                          │
 │         "type": "http",                                                             │
 │         "http": {                                                                   │
 │           "url": "https://api.example.com/mcp"                                    │
 │         }                                                                          │
 │       }                                                                            │
 │     ]                                                                              │
 │   }                                                                                 │
 │                                                                                     │
 │   加载流程:                                                                         │
 │   1. MCPToolLoader.load() 读取配置                                                 │
 │   2. MCPManager.connectAll() 连接所有服务器                                        │
 │   3. MCPToolWrapper.wrapMCPTools() 包装工具为内部格式                               │
 │   4. toolRegistry.register() 注册到工具注册表                                     │
 │                                                                                     │
 └─────────────────────────────────────────────────────────────────────────────────────┘
              │                            │                            │
              ▼                            ▼                            ▼
 ┌─────────────────────────────────────────────────────────────────────────────────────┐
 │                           消息/任务工具                                               │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐          │
│   │ 5. MessageTool  │       │ 6. SpawnTool    │       │ 7. CronTool     │          │
│   │                 │       │                 │       │                 │          │
│   │ 发送消息到指定渠道 │       │ 生成新任务        │       │ 管理定时任务      │          │
│   │                 │       │                 │       │                 │          │
│   │ MessageTool:    │       │ SpawnTool:      │       │ CronTool:       │          │
│   │ - channel       │       │ - agent         │       │ - schedule      │          │
│   │ - chatId        │       │ - prompt        │       │ - cancel        │          │
│   │ - content       │       │ - channel       │       │ - list          │          │
│   │                 │       │                 │       │                 │          │
│   │ 通过 MessageBus  │       │ 通过 MessageBus  │       │ 通过 CronService│          │
│   │ 发布 inbound    │       │ 发布 inbound    │       │ 注册定时任务      │          │
│   └────────┬────────┘       └────────┬────────┘       └────────┬────────┘          │
│            │                        │                        │                      │
└────────────┼────────────────────────┼────────────────────────┼──────────────────────┘
             │                        │                        │
             │                        │                        │
             ▼                        ▼                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           工具结果返回                                               │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   所有工具返回字符串结果:                                                          │
│                                                                                     │
│   result = await tool.execute(args);                                              │
│                                                                                     │
│   // 结果截断 (避免过长)                                                           │
│   if (result.length > 500) {                                                      │
│     result = result.slice(0, 500) + '\n... (truncated)';                          │
│   }                                                                                │
│                                                                                     │
│   // 返回给 LLM                                                                    │
│   return `Tool "${name}" returned:\n${result}`;                                    │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
                           ┌───────────────────────────────┐
                           │ Vercel AI SDK                 │
                           │ 将工具结果反馈给 LLM           │
                           │ LLM 继续生成后续内容           │
                           │ 或决定调用更多工具              │
                           └───────────────┬─────────────┘
                                           │
                      [达到 maxSteps 或无更多工具调用]
                                           │
                                           ▼
                           ┌───────────────────────────────┐
                           │ 返回最终文本响应                │
                           └───────────────────────────────┘
```

## 6. 记忆整合流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           记忆整合详细流程                                   │
└─────────────────────────────────────────────────────────────────────────────┘

AgentLoop._processMessage() 完成消息处理后
│
▼
┌───────────────────────────────┐
│          获取当前会话          │
│  session = await sessions     │
│    .getOrCreate(sessionKey)   │
└───────────────┬─────────────┘
                │
                ▼
┌───────────────────────────────┐
│        检查是否需要整合        │
│    needsConsolidation(session)│
├───────────────────────────────┤
│           检查条件:           │
│    1. 消息数量 >= 20          │
│    2. (messages.length -      │
│        lastConsolidated) >=   │
│        consolidationThreshold │
└───────────────┬─────────────┘
                │
        ┌───────┴───────┐
        │               │
        ▼               ▼
┌─────────────────────┐ ┌─────────────────────┐
│    跳过记忆整合     │ │    开始记忆整合     │
└─────────────────────┘ └──────────┬──────────┘
                                   │
                                   ▼
┌───────────────────────────────┐
│        consolidate(session)   │
├───────────────────────────────┤
│          步骤1: 准备归档      │
│          ├─ 提取未归档的消息  │
│          │  (from lastConsolidated) │
│          └─ 保存归档时间戳    │
│                               │
│          步骤2: 调用 LLM 提取记忆 │
│          ├─ 构建提示词:       │
│          │  "从对话历史中提取重要信息 │
│          │   包括:            │
│          │   1. 用户偏好      │
│          │   2. 重要决策      │
│          │   3. 待办事项      │
│          │   4. 技能使用记录" │
│          └─ LLM 提取结构化记忆 │
│                               │
│          步骤3: 存储长期记忆  │
│          ├─ 写入 memory/long-term.md │
│          └─ 格式化存储        │
│             - 用户偏好        │
│             - 重要上下文      │
│             - 已完成任务      │
│                               │
│          步骤4: 归档旧消息    │
│          ├─ 保存到            │
│             memory/archived/  │
│             {sessionKey}.json │
│          └─ 清理当前会话消息  │
│             (保留最后5条作为上下文) │
│                               │
│          步骤5: 更新会话元数据 │
│          ├─ lastConsolidated = │
│             messages.length    │
│          └─ 保存会话          │
└───────────────┬─────────────┘
                │
                ▼
┌───────────────────────────────┐
│           保存会话            │
│  sessions.saveSession(session)│
└───────────────┬─────────────┘
                │
                ▼
┌───────────────────────────────┐
│        返回 OutboundMessage    │
└───────────────────────────────┘
```

## 7. 技能加载和使用流程

```

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         技能加载和使用流程                                             │
└─────────────────────────────────────────────────────────────────────────────────────┘

启动时 (cmdGateway)
                                          │
                                          ▼
                           ┌───────────────────────────────┐
                           │ 初始化 SkillLoader            │
                           │ const skills = new            │
                           │   SkillLoader(config)         │
                           └───────────────┬─────────────┘
                                           │
                                           ▼
                           ┌───────────────────────────────┐
                           │ skills.init()                 │
                           ├───────────────────────────────┤
                           │ 扫描技能目录:                 │
                           │ workspace/skills/             │
                           │   └─ *.ts (技能定义文件)       │
                           │                               │
                           │ 动态导入技能模块:             │
                           │ import(skillPath)             │
                           │                               │
                           │ 提取技能元数据:               │
                           │ - name: 技能名称               │
                           │ - description: 技能描述         │
                           │ - always: 是否始终可用          │
                           │ - trigger: 触发关键词           │
                           └───────────────┬─────────────┘
                                           │
                                           ▼
                           ┌───────────────────────────────┐
                           │ 技能分类存储:                 │
                           │ ├─ alwaysSkills: []           │
                           │ │  (始终显示在系统提示词中)     │
                           │ └─ onDemandSkills: Map        │
                           │    (按需触发)                 │
                           └───────────────┬─────────────┘
                                           │
处理消息时 (_processMessage)
                                           │
                                           ▼
                           ┌───────────────────────────────┐
                           │ 构建系统提示词                 │
                           │ ContextBuilder.              │
                           │   buildSystemPrompt({        │
                           │     workspace,               │
                           │     alwaysSkills,             │
                           │     memoryContext,            │
                           │     skillsSummary             │
                           │   })                         │
                           └───────────────┬─────────────┘
                                           │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           系统提示词结构                                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   [Identity]                                                                         │
│   你是 Nanobot，一个超轻量级个人 AI 助手...                                          │
│                                                                                     │
│   [Bootstrap]                                                                        │
│   你可以访问文件系统、执行命令、搜索网络...                                          │
│                                                                                     │
│   [Available Skills]                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐    │
│   │ alwaysSkills (始终可用):                                                 │    │
│   │  1. code_review - 代码审查和质量检查                                      │    │
│   │  2. refactoring - 代码重构                                               │    │
│   └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
│   [Memory Context]                                                                  │
│   长期记忆:                                                                          │
│   - 用户偏好: 喜欢 TypeScript，偏好函数式编程                                       │
│   - 重要上下文: 正在开发 nanobot-ts 项目                                            │
│   - 已完成任务: 配置了 ESLint v10                                                   │
│                                                                                     │
│   [Current Context]                                                                  │
│   - Channel: cli                                                                    │
│   - ChatId: direct                                                                  │
│   - Workspace: ~/.nanobot/workspace                                                 │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
                           ┌───────────────────────────────┐
                           │ LLM 根据提示词和消息生成回复    │
                           │ 可能会:                      │
                           │ ├─ 使用工具                  │
                           │ ├─ 调用技能                  │
                           │ └─ 查阅记忆                  │
                           └───────────────┬─────────────┘
                                           │
                                           ▼
                           ┌───────────────────────────────┐
                           │ 返回响应                      │
                           └───────────────────────────────┘
```

## 8. 错误处理流程

```

┌─────────────────────────────────────────────────────────────────────────────┐
│                           错误处理流程                                       │
└─────────────────────────────────────────────────────────────────────────────┘

AgentLoop.run() 主循环
│
▼
┌───────────────────────────────┐
│        consumeInbound()       │
└───────────────┬─────────────┘
                │
                ▼
┌───────────────────────────────┐
│ try {                         │
│   const response =            │
│     await this                │
│       ._processMessage(msg);  │
│   if (response)               │
│     await bus                 │
│       .publishOutbound(       │
│         response              │
│       );                      │
│ } catch (rawErr) {            │
│   // 错误处理                 │
│ }                             │
└───────────────┬─────────────┘
                │
    [发生错误]────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                               错误分类处理                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 1. ProviderError (LLM 调用错误)                                             │
│    ├─ API Key 无效                                                         │
│    ├─ 网络超时                                                             │
│    ├─ 模型不存在                                                           │
│    └─ 处理: 记录错误日志，继续等待下一条消息                                │
│                                                                             │
│ 2. ToolExecutionError (工具执行错误)                                        │
│    ├─ 文件不存在                                                           │
│    ├─ 命令执行失败                                                         │
│    ├─ 网络请求失败                                                         │
│    └─ 处理: 返回错误信息给 LLM，LLM 可以尝试其他方法                        │
│                                                                             │
│ 3. SessionError (会话错误)                                                  │
│    ├─ 会话保存失败                                                         │
│    ├─ 记忆整合失败                                                         │
│    └─ 处理: 记录错误，继续运行                                              │
│                                                                             │
│ 4. ChannelError (渠道错误)                                                  │
│    ├─ 发送失败                                                             │
│    ├─ 连接断开                                                             │
│    └─ 处理: ChannelManager 会捕获并记录                                     │
│                                                                             │
│ 5. UnknownError (未知错误)                                                  │
│    └─ 处理: 记录完整错误信息和堆栈，继续运行                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────┐
│ logger.error({                │
│   err,                        │
│   message,                    │
│   stack                       │
│ }, 'Error processing message')│
└───────────────┬─────────────┘
                │
                ▼
┌───────────────────────────────┐
│ 继续主循环，等待下一条消息    │
└───────────────────────────────┘

```

## 9. 关键组件交互时序图

```

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          组件交互时序图                                                │
└─────────────────────────────────────────────────────────────────────────────────────┘

用户输入     MessageBus     AgentLoop    LLMProvider   ToolRegistry   ChannelManager
  │              │              │              │              │              │
  │────输入─────▶│              │              │              │              │
  │              │              │              │              │              │
  │              │──publishInbound()──────────────────────────────────────────────▶│
  │              │              │              │              │              │
  │              │◀────────────────────────────────────────────consumeInbound()────│
  │              │              │              │              │              │
  │              │              │              │              │              │
  │              │              │────_processMessage()──────▶│              │
  │              │              │              │              │              │
  │              │              │◀────会话历史───│              │              │
  │              │              │              │              │              │
  │              │              │──构建提示词──▶│              │              │
  │              │              │              │              │              │
  │              │              │──getDefinitions()───────────▶│              │
  │              │              │              │              │              │
  │              │              │◀────工具列表───│              │              │
  │              │              │              │              │              │
  │              │              │──chat(params)─▶│              │              │
  │              │              │              │              │              │
  │              │              │              │──generateText()──▶ (Vercel AI SDK)
  │              │              │              │              │              │
  │              │              │              │◀────文本/工具调用─│              │
  │              │              │              │              │              │
  │              │              │              │──executeTool()──────────────▶│
  │              │              │              │              │              │
  │              │              │              │◀────工具结果───│              │
  │              │              │              │              │              │
  │              │              │◀────最终响应───│              │              │
  │              │              │              │              │              │
  │              │──publishOutbound()──────────────────────────────────────────▶│
  │              │              │              │              │              │
  │              │              │              │              │              │
  │              │              │              │              │              │
  │◀─────────────┴──consumeOutbound()─────────────────────────────────────────│
  │              │              │              │              │              │
  │              │              │              │              │              │
  │              │              │              │              │              │
  │◀────发送响应──│              │              │              │              │
  │              │              │              │              │              │


```

## 10. 关键配置说明

```

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          关键配置参数                                                  │
└─────────────────────────────────────────────────────────────────────────────────────┘

配置文件: ~/.nanobot/config.json
├─ providers
│  ├─ openai.apiKey
│  ├─ anthropic.apiKey
│  ├─ deepseek.apiKey
│  └─ openrouter.apiKey
│
├─ agents.defaults
│  ├─ model: "openai:gpt-4o-mini"
│  ├─ temperature: 0.7
│  ├─ maxTokens: 4096
│  ├─ maxIterations: 3          # 最大工具调用步数
│  ├─ memoryWindow: 20          # 会话历史窗口大小
│  └─ workspace: "~/.nanobot/workspace"
│
├─ channels
│  ├─ whatsapp.enabled
│  ├─ feishu.enabled
│  └─ email.enabled
│
└─ memory.consolidationThreshold: 20

```

## 11. 启动和停止流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        启动流程 (cmdGateway)                                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

1. 加载配置
   └─ loadConfig()

2. 初始化核心组件
   ├─ MessageBus
   ├─ SessionManager
   ├─ LLMProvider
   ├─ ToolRegistry
   ├─ CronService (启动)
   ├─ MemoryConsolidator
   └─ SkillLoader

3. 创建 Agent
   └─ new AgentLoop({...})

4. 初始化渠道
   ├─ ChannelManager
   ├─ 注册 CLIChannel
   ├─ 从配置加载其他渠道 (WhatsApp, Feishu, Email)
   └─ 启动所有渠道

5. 启动出站循环
   └─ channelManager.runOutboundLoop()

6. 启动 Agent 主循环
   └─ agent.run()

7. 进入交互式提示符
   └─ readline: "You> "

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        停止流程 (Ctrl+C)                                              │
└─────────────────────────────────────────────────────────────────────────────────────┘

1. 用户输入 /exit 或 Ctrl+C
   └─ 读取信号

2. 停止 Agent
   ├─ agent.stop()
   └─ 设置 running = false

3. 停止渠道
   ├─ channelManager.stop()
   └─ channelManager.stopAll()

4. 关闭 CLI
   ├─ rl.close()
   └─ process.exit(0)

5. 资源清理
   ├─ CronService 停止
   ├─ 会话保存
   └─ 日志刷新
```

## 总结

Gateway 模式采用了 **事件驱动 + 发布/订阅** 的架构，实现了以下特性:

1. **解耦**: 渠道、Agent、工具之间完全解耦，通过 MessageBus 通信
2. **扩展性**: 可以轻松添加新的渠道、工具或技能
3. **可靠性**: 队列机制确保消息不会丢失，错误不会导致整个系统崩溃
4. **并发性**: 多个渠道可以同时发送消息，Agent 顺序处理
5. **可观测性**: 每个步骤都有日志记录，便于调试
6. **模块化**: 每个组件职责单一，易于维护和测试

核心流程:
入站消息 → MessageBus → AgentLoop → LLM → 工具执行 → 出站消息 → MessageBus → ChannelManager → 具体渠道
