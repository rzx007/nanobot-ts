# Nanobot TypeScript ç‰ˆæœ¬ - äº§å“éœ€æ±‚æ–‡æ¡£ (PRD)

**ç‰ˆæœ¬**: 0.1.0
**æ—¥æœŸ**: 2026-02-25
**ä½œè€…**: Nanobot TypeScript å›¢é˜Ÿ
**çŠ¶æ€**: è¿›è¡Œä¸­

---

## 1. æ¦‚è¿°

### 1.1 äº§å“ç›®æ ‡

Nanobot TypeScript ç‰ˆæœ¬æ˜¯å¯¹åŸ Python ç‰ˆæœ¬çš„å®Œæ•´é‡æ–°å®ç°ï¼Œç›®æ ‡æ˜¯ï¼š

- **æ€§èƒ½æ›´ä¼˜**ï¼šåˆ©ç”¨ Node.js çš„éé˜»å¡ I/O å’Œäº‹ä»¶é©±åŠ¨æ¶æ„
- **å¼€å‘ä½“éªŒ**ï¼šå®Œæ•´çš„ç±»å‹å®‰å…¨å’Œ IDE æ”¯æŒ
- **ç”Ÿæ€é›†æˆ**ï¼šä¸ JavaScript/TypeScript ç”Ÿæ€æ— ç¼é›†æˆ
- **æ¨¡å—åŒ–**ï¼šæ¸…æ™°çš„æ¶æ„è®¾è®¡ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤
- **åŠŸèƒ½å¯¹ç­‰**ï¼šä¿æŒä¸ Python ç‰ˆæœ¬æ ¸å¿ƒåŠŸèƒ½å…¼å®¹

### 1.2 äº§å“æ„¿æ™¯

Nanobot æ˜¯ä¸€ä¸ªè¶…è½»é‡çº§çš„ä¸ªäºº AI åŠ©æ‰‹æ¡†æ¶ã€‚æ— è®ºç”¨ä»€ä¹ˆè¯­è¨€å®ç°ï¼Œéƒ½åº”è¯¥ï¼š

âœ¨ è¶…è½»é‡ (~5000 è¡Œä»£ç )
ğŸš€ å¼€ç®±å³ç”¨ (2 åˆ†é’Ÿå¯åŠ¨)
ğŸ”Œ å¤šæ¸ é“é›†æˆ (WhatsApp, Feishu, Email)
ğŸ§  æ™ºèƒ½å¯¹è¯ (LLM é©±åŠ¨)
ğŸ› ï¸ å¼ºå¤§å·¥å…· (æ–‡ä»¶ã€ç½‘ç»œã€æ‰§è¡Œç­‰)
ğŸ¯ æ¨¡å—åŒ–è®¾è®¡ (æ˜“äºæ‰©å±•)

### 1.3 æŠ€æœ¯é€‰å‹

| ç±»åˆ« | é€‰æ‹© | ç†ç”± |
|------|------|------|
| **LLM SDK** | @ai-sdk (Vercel AI SDK) | ç»Ÿä¸€çš„æä¾›å•†æ¥å£ï¼Œæ”¯æŒ OpenAIã€Anthropicã€OpenRouter ç­‰ |
| **é…ç½®ç®¡ç†** | zod + cosmiconfig | ç±»å‹å®‰å…¨çš„é…ç½® Schemaï¼Œçµæ´»çš„é…ç½®æ–‡ä»¶æ ¼å¼ |
| **CLI æ¡†æ¶** | commander | æˆç†Ÿç¨³å®šçš„ Node.js CLI åº“ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | EventEmitter + async-queue | åŸç”Ÿäº‹ä»¶é©±åŠ¨ï¼Œæ— é¢å¤–ä¾èµ– |
| **æ—¥å¿—ç³»ç»Ÿ** | pino | é«˜æ€§èƒ½ JSON æ—¥å¿—ï¼Œç”Ÿäº§å°±ç»ª |
| **HTTP å®¢æˆ·ç«¯** | undici | Node.js åŸç”Ÿé«˜æ€§èƒ½ HTTP å®¢æˆ·ç«¯ |
| **æ–‡ä»¶ç³»ç»Ÿ** | fs-extra | Promise é£æ ¼çš„ fs API |
| **WhatsApp** | baileys | æœ€æˆç†Ÿçš„ WhatsApp åº“ |
| **Feishu** | @larksuiteoapi/node-sdk | å®˜æ–¹ TypeScript SDK |
| **Email** | imapflow + nodemailer | ç°ä»£åŒ–çš„ IMAP/SMTP åº“ |
| **æµ‹è¯•æ¡†æ¶** | vitest | å¿«é€Ÿã€Vite ç”Ÿæ€ |

### 1.4 æˆåŠŸæŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| ä»£ç è¡Œæ•° | < 5000 è¡Œ |
| å¯åŠ¨æ—¶é—´ | < 2 ç§’ |
| å†…å­˜å ç”¨ | < 120 MB |
| æ¶ˆæ¯å»¶è¿Ÿ | < 100 ms |
| æµ‹è¯•è¦†ç›–ç‡ | > 80% |
| ç±»å‹è¦†ç›–ç‡ | 100% |

---

## 2. ç”¨æˆ·åœºæ™¯

### 2.1 ä¸»è¦ç”¨æˆ·è§’è‰²

#### ç”¨æˆ· A: ä¸ªäººä½¿ç”¨è€…

- **éœ€æ±‚**ï¼šåœ¨å¤šä¸ªèŠå¤©åº”ç”¨(WhatsApp, Feishu, Email)ä¸Šæœ‰ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹
- **åœºæ™¯**ï¼šå¿«é€ŸæŸ¥è¯¢ä¿¡æ¯ã€ç¼–å†™ä»£ç ã€æ‰§è¡Œä»»åŠ¡
- **å…³é”®åŠŸèƒ½**ï¼šæ¶ˆæ¯è·¯ç”±ã€å·¥å…·è°ƒç”¨ã€è®°å¿†ç®¡ç†

#### ç”¨æˆ· B: å¼€å‘è€…

- **éœ€æ±‚**ï¼šå¿«é€Ÿé›†æˆ AI ä»£ç†åˆ°ç°æœ‰åº”ç”¨
- **åœºæ™¯**ï¼šæ·»åŠ æ–°çš„èŠå¤©æ¸ é“ã€è‡ªå®šä¹‰å·¥å…·ã€ä¿®æ”¹ Agent è¡Œä¸º
- **å…³é”®åŠŸèƒ½**ï¼šæ’ä»¶ç³»ç»Ÿã€å·¥å…· APIã€äº‹ä»¶é’©å­

#### ç”¨æˆ· C: ç ”ç©¶è€…

- **éœ€æ±‚**ï¼šç ”ç©¶ AI ä»£ç†æ¶æ„ï¼Œä¿®æ”¹æ ¸å¿ƒé€»è¾‘
- **åœºæ™¯**ï¼šæµ‹è¯•æ–°çš„æç¤ºè¯ç­–ç•¥ã€å®éªŒè®°å¿†ç®—æ³•
- **å…³é”®åŠŸèƒ½**ï¼šä»£ç å¯è¯»æ€§ã€æ¸…æ™°çš„æ¶æ„ã€æ˜“äºä¿®æ”¹

### 2.2 æ ¸å¿ƒç”¨æˆ·æ•…äº‹

**æ•…äº‹ 1: å¯åŠ¨ AI åŠ©æ‰‹**

ä½œä¸º [ä¸ªäººä½¿ç”¨è€…]
æˆ‘æƒ³ [å¿«é€Ÿå¯åŠ¨ nanobot å¹¶è¿æ¥åˆ° WhatsApp/Feishu]
ä»¥ä¾¿ [ç«‹å³å¼€å§‹èŠå¤©]

éªŒæ”¶æ ‡å‡†ï¼š
- âœ… nanobot start å‘½ä»¤ < 2 ç§’å¯åŠ¨
- âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆè‡ªåŠ¨åŒ–
- âœ… é¦–æ¬¡ä½¿ç”¨æœ‰å¼•å¯¼æç¤º

**æ•…äº‹ 2: å¤„ç†æ¶ˆæ¯**

ä½œä¸º [ç³»ç»Ÿ]
æˆ‘æƒ³ [ä»ä»»ä½•æ¸ é“æ¥æ”¶æ¶ˆæ¯å¹¶è·¯ç”±åˆ° Agent]
ä»¥ä¾¿ [ç»Ÿä¸€å¤„ç†ä¸åŒå¹³å°çš„æ¶ˆæ¯]

éªŒæ”¶æ ‡å‡†ï¼š
- âœ… æ”¯æŒ WhatsApp, Feishu, Email
- âœ… æ¶ˆæ¯è·¯ç”±å»¶è¿Ÿ < 50ms
- âœ… æ”¯æŒåª’ä½“æ–‡ä»¶å¤„ç†

**æ•…äº‹ 3: æ‰§è¡Œå·¥å…·**

ä½œä¸º [Agent]
æˆ‘æƒ³ [è°ƒç”¨å†…ç½®å·¥å…·(æ–‡ä»¶ã€ç½‘ç»œã€æ‰§è¡Œç­‰)]
ä»¥ä¾¿ [å®Œæˆå¤æ‚ä»»åŠ¡]

éªŒæ”¶æ ‡å‡†ï¼š
- âœ… æ–‡ä»¶è¯»å†™å·¥å…·
- âœ… Web æœç´¢/è·å–å·¥å…·
- âœ… Shell æ‰§è¡Œå·¥å…·
- âœ… æ¶ˆæ¯å‘é€å·¥å…·
- âœ… å·¥å…·è¶…æ—¶å’Œé”™è¯¯å¤„ç†

**æ•…äº‹ 4: ç®¡ç†ä¼šè¯**

ä½œä¸º [ç³»ç»Ÿ]
æˆ‘æƒ³ [ä¿å­˜å’ŒåŠ è½½ç”¨æˆ·ä¼šè¯]
ä»¥ä¾¿ [ç»´æŒé•¿æœŸçš„å¯¹è¯è®°å¿†]

éªŒæ”¶æ ‡å‡†ï¼š
- âœ… ä¼šè¯æŒä¹…åŒ–åˆ°ç£ç›˜
- âœ… æ”¯æŒå¤šä¸ªå¹¶å‘ä¼šè¯
- âœ… å†…å­˜å‹ç¼©å’Œå½’æ¡£

---

## 3. åŠŸèƒ½éœ€æ±‚

### 3.1 æ ¸å¿ƒåŠŸèƒ½

#### F1: æ¶ˆæ¯æ€»çº¿ (Message Bus)

- **æè¿°**ï¼šå¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œè§£è€¦æ¸ é“å’Œ Agent
- **è´£ä»»**ï¼š
  - æ¥æ”¶æ¥è‡ªå„æ¸ é“çš„å…¥ç«™æ¶ˆæ¯
  - è·¯ç”±æ¶ˆæ¯ç»™ Agent å¤„ç†
  - å°†å›å¤åˆ†å‘å›ç›¸åº”æ¸ é“
- **æ€§èƒ½ç›®æ ‡**ï¼šæ¶ˆæ¯åå > 100 msg/s
- **æŠ€æœ¯å®ç°**ï¼šNode.js EventEmitter + ç®€å•çš„ Promise é˜Ÿåˆ—

#### F2: Agent Loop

- **æè¿°**ï¼šæ ¸å¿ƒå¤„ç†å¼•æ“ï¼Œé©±åŠ¨ AI å¯¹è¯
- **å·¥ä½œæµ**ï¼š
  1. æ¶ˆè´¹å…¥ç«™æ¶ˆæ¯
  2. æ„å»ºæç¤ºè¯ä¸Šä¸‹æ–‡
  3. è°ƒç”¨ LLM API
  4. è§£æå·¥å…·è°ƒç”¨
  5. æ‰§è¡Œå·¥å…·
  6. å¾ªç¯æˆ–è¿”å›æœ€ç»ˆå“åº”
- **é…ç½®å‚æ•°**ï¼š
  - `maxIterations`: æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•° (é»˜è®¤ 40)
  - `temperature`: LLM æ¸©åº¦ (é»˜è®¤ 0.1)
  - `memoryWindow`: ä¿ç•™çš„å†å²æ¶ˆæ¯æ•° (é»˜è®¤ 100)

#### F3: å·¥å…·ç³»ç»Ÿ (Tool Registry)

- **æè¿°**ï¼šå·¥å…·æ³¨å†Œå’Œæ‰§è¡Œæ¡†æ¶
- **å†…ç½®å·¥å…·**ï¼š
  - `read_file`: è¯»å–æ–‡ä»¶
  - `write_file`: å†™å…¥æ–‡ä»¶
  - `edit_file`: ç¼–è¾‘æ–‡ä»¶æŒ‡å®šè¡Œ
  - `list_dir`: åˆ—å‡ºç›®å½•
  - `exec`: æ‰§è¡Œ shell å‘½ä»¤
  - `web_search`: ç½‘ç»œæœç´¢ (éœ€è¦ API)
  - `web_fetch`: è·å–ç½‘é¡µå†…å®¹
  - `message`: å‘é€æ¶ˆæ¯åˆ°æŒ‡å®šæ¸ é“
  - `spawn`: ç”Ÿæˆåå°å­ä»£ç†
- **æ‰©å±•æœºåˆ¶**ï¼šå¼€å‘è€…å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰å·¥å…·

#### F4: å¤šæ¸ é“é›†æˆ

- **ç›®æ ‡æ¸ é“**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
  - **WhatsApp** (ä¼˜å…ˆçº§: é«˜) - ä½¿ç”¨ Baileys åº“
  - **Feishu/Lark** (ä¼˜å…ˆçº§: é«˜) - ä½¿ç”¨ @larksuiteoapi/node-sdk å®˜æ–¹ SDK
  - **Email** (ä¼˜å…ˆçº§: ä¸­) - ä½¿ç”¨ imapflow + nodemailer
  - **CLI** (ä¼˜å…ˆçº§: é«˜) - ç›´æ¥å‘½ä»¤è¡Œäº¤äº’

#### F5: ä¼šè¯ç®¡ç† (Session)

- **åŠŸèƒ½**ï¼š
  - ä¸ºæ¯ä¸ªç”¨æˆ·/èŠå¤©åˆ›å»ºç‹¬ç«‹ä¼šè¯
  - ä¿å­˜å¯¹è¯å†å²
  - å®ç°ä¼šè¯å‘½ä»¤ (`/new`, `/help`)
  - æ”¯æŒå¹¶å‘ä¼šè¯
- **å­˜å‚¨æ ¼å¼**ï¼šJSONL (æ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡)

#### F6: å†…å­˜ç³»ç»Ÿ (Memory)

- **åŠŸèƒ½**ï¼š
  - çŸ­æœŸè®°å¿†ï¼šå½“å‰å¯¹è¯å†å² (æœ€å¤š 100 æ¡æ¶ˆæ¯)
  - é•¿æœŸè®°å¿†ï¼šå½’æ¡£çš„æ‘˜è¦å’Œå…³é”®ä¿¡æ¯
  - è‡ªåŠ¨å‹ç¼©ï¼šå½“æ¶ˆæ¯è¶…è¿‡é˜ˆå€¼æ—¶
  - æœç´¢ï¼šæ”¯æŒå…³é”®è¯æœç´¢å†å²
- **å­˜å‚¨ç»“æ„**ï¼š
  - `memory/MEMORY.md`: é•¿æœŸäº‹å®
  - `memory/HISTORY.md`: å¯æœç´¢çš„å¯¹è¯æ—¥å¿—

#### F7: LLM Provider é›†æˆ

- **æ”¯æŒæä¾›å•†**ï¼š
  - OpenAI (GPT-4, GPT-3.5, GPT-4.1, o1)
  - Anthropic (Claude 3.5, Claude 3, Claude Opus)
  - OpenRouter (ç½‘å…³ï¼Œè®¿é—®æ‰€æœ‰æ¨¡å‹)
  - DeepSeek (DeepSeek-V3, DeepSeek-R1)
  - Groq (Llama 3, Mixtral)
  - (æ‰©å±•: Zhipu, Qwen, Gemini, MiniMax ç­‰)
- **åŠŸèƒ½**ï¼š
  - ç»Ÿä¸€çš„ Provider æ¥å£ (@ai-sdk)
  - è‡ªåŠ¨é”™è¯¯é‡è¯•
  - Rate limit å¤„ç†
  - Prompt caching æ”¯æŒï¼ˆAnthropicï¼‰

#### F8: é…ç½®ç³»ç»Ÿ

- **é…ç½®ä½ç½®**ï¼š`~/.nanobot/config.json`
- **æ”¯æŒçš„é…ç½®**ï¼š
  - Agent æ¨¡å‹å’Œå‚æ•°
  - Provider ä¿¡æ¯å’Œ API å¯†é’¥
  - å¯ç”¨çš„æ¸ é“å’Œå‡­è¯
  - å·¥å…·è®¾ç½®
- **é…ç½®æ ¼å¼**ï¼šJSONï¼ˆä½¿ç”¨ Zod Schema éªŒè¯ï¼‰

#### F9: æŠ€èƒ½ç³»ç»Ÿ (Skills)

- **åŠŸèƒ½**ï¼š
  - å†…ç½®æŠ€èƒ½ï¼šweather, github, memory, cron, summarize ç­‰
  - æŒ‰éœ€åŠ è½½ï¼šAgent å¯é€šè¿‡ read_file åŠ¨æ€åŠ è½½
  - è‡ªå®šä¹‰æŠ€èƒ½ï¼šç”¨æˆ·å¯åœ¨ `workspace/skills/` æ·»åŠ  SKILL.md

### 3.2 éåŠŸèƒ½éœ€æ±‚

| éœ€æ±‚ | æè¿° | éªŒæ”¶æ ‡å‡† |
|------|------|---------|
| **æ€§èƒ½** | æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ | < 100ms |
| **å¯é æ€§** | é”™è¯¯å¤„ç†å’Œæ¢å¤ | 99.9% æ­£å¸¸è¿è¡Œ |
| **å®‰å…¨æ€§** | API å¯†é’¥åŠ å¯†ã€è®¿é—®æ§åˆ¶ | é€šè¿‡å®‰å…¨å®¡æŸ¥ |
| **å¯æ‰©å±•æ€§** | æ”¯æŒæ·»åŠ æ–°æ¸ é“å’Œå·¥å…· | < 50 è¡Œä»£ç  |
| **å¯ç»´æŠ¤æ€§** | ä»£ç è´¨é‡å’Œæ–‡æ¡£ | ESLint + TypeDoc |
| **å…¼å®¹æ€§** | Node.js ç‰ˆæœ¬ | >= 18.0.0 |

---

## 4. æŠ€æœ¯æ¶æ„

### 4.1 åˆ†å±‚æ¶æ„

```plaintext

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          CLI / Gateway          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Channel Manager          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WhatsApp â”‚  Feishu   â”‚ Email  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†•
           Message Busï¼ˆä¸­å¤®è·¯ç”±ï¼‰
                  â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Agent Loop            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Context | Memory | Tools    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Provider Interface        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   OpenAI  â”‚ Anthropic â”‚OpenRouterâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å…³é”®ç»„ä»¶

| ç»„ä»¶ | èŒè´£ | å…³é”®æ¥å£ |
|------|------|---------|
| **MessageBus** | æ¶ˆæ¯é˜Ÿåˆ—å’Œè·¯ç”± | `publishInbound()`, `consumeInbound()` |
| **AgentLoop** | ä¸»å¤„ç†é€»è¾‘ | `run()`, `process()` |
| **ToolRegistry** | å·¥å…·ç®¡ç† | `register()`, `execute()` |
| **ChannelManager** | æ¸ é“ç”Ÿå‘½å‘¨æœŸ | `startAll()`, `stopAll()` |
| **SessionManager** | ä¼šè¯å­˜å‚¨ | `get()`, `save()` |
| **ContextBuilder** | æç¤ºè¯æ„å»º | `buildMessages()` |
| **MemoryStore** | é•¿æœŸè®°å¿†ç®¡ç† | `consolidate()`, `readLongTerm()` |

### 4.3 äº¤äº’æµç¨‹

```plaintext
User Message (WhatsApp)
   â†“
WhatsAppChannel.handleMessage()
   â†“
MessageBus.publishInbound()
   â†“
AgentLoop.run() â†’ consumeInbound()
   â†“
_processMessage()
   â”œâ”€ buildMessages() â†’ LLM (@ai-sdk)
   â”œâ”€ [æœ‰å·¥å…·è°ƒç”¨] â†’ execute tools
   â””â”€ [æ— å·¥å…·è°ƒç”¨] â†’ è¿”å›å“åº”
   â†“
MessageBus.publishOutbound()
   â†“
ChannelManager._dispatch()
   â†“
WhatsAppChannel.send()
   â†“
User receives message
```

### 4.4 ç›®å½•ç»“æ„

```bash
nanobot-ts/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/                    # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ agent.ts            # Agent ä¸»å¾ªç¯
â”‚   â”‚   â”œâ”€â”€ context.ts          # æç¤ºè¯æ„å»º
â”‚   â”‚   â”œâ”€â”€ memory.ts           # ä¼šè¯è®°å¿†
â”‚   â”‚   â”œâ”€â”€ skills.ts           # æŠ€èƒ½åŠ è½½å™¨
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ bus/                     # æ¶ˆæ¯æ€»çº¿
â”‚   â”‚   â”œâ”€â”€ queue.ts            # æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â”‚   â”œâ”€â”€ events.ts           # ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ channels/                # æ¸ é“å®ç°
â”‚   â”‚   â”œâ”€â”€ base.ts             # BaseChannel æŠ½è±¡ç±»
â”‚   â”‚   â”œâ”€â”€ whatsapp.ts         # WhatsApp (Baileys)
â”‚   â”‚   â”œâ”€â”€ feishu.ts          # Feishu (@larksuiteoapi/node-sdk)
â”‚   â”‚   â”œâ”€â”€ email.ts            # Email (imapflow + nodemailer)
â”‚   â”‚   â””â”€â”€ manager.ts         # æ¸ é“ç®¡ç†å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ providers/               # LLM æä¾›å•†
â”‚   â”‚   â”œâ”€â”€ registry.ts         # æä¾›å•†æ³¨å†Œè¡¨
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ tools/                   # å·¥å…·ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ base.ts             # Tool æŠ½è±¡ç±»
â”‚   â”‚   â”œâ”€â”€ registry.ts         # ToolRegistry
â”‚   â”‚   â”œâ”€â”€ filesystem.ts       # æ–‡ä»¶æ“ä½œ
â”‚   â”‚   â”œâ”€â”€ shell.ts            # Shell æ‰§è¡Œ
â”‚   â”‚   â”œâ”€â”€ web.ts              # ç½‘ç»œç›¸å…³
â”‚   â”‚   â”œâ”€â”€ message.ts          # æ¶ˆæ¯å‘é€
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                  # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ schema.ts           # é…ç½® Schema (Zod)
â”‚   â”‚   â”œâ”€â”€ loader.ts           # é…ç½®æ–‡ä»¶åŠ è½½
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/                 # å­˜å‚¨å±‚
â”‚   â”‚   â”œâ”€â”€ session.ts          # ä¼šè¯å­˜å‚¨
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ cli/                     # CLI å‘½ä»¤
â”‚   â”‚   â”œâ”€â”€ index.ts            # å‘½ä»¤å…¥å£
â”‚   â”‚   â”œâ”€â”€ commands/           # å…·ä½“å‘½ä»¤
â”‚   â”‚   â”‚   â”œâ”€â”€ agent.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ gateway.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ config.ts
â”‚   â”‚   â”‚   â””â”€â”€ channels.ts
â”‚   â”‚   â””â”€â”€ ui.ts              # ç»ˆç«¯ UI (ora, inquirer)
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ logger.ts           # Pino æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ errors.ts           # è‡ªå®šä¹‰é”™è¯¯
â”‚   â”‚   â””â”€â”€ helpers.ts          # è¾…åŠ©å‡½æ•°
â”‚   â”‚
â”‚   â””â”€â”€ index.ts                 # å¯¼å‡ºä¸»å…¥å£
â”‚
â”œâ”€â”€ templates/                  # æ¨¡æ¿æ–‡ä»¶
â”‚   â”œâ”€â”€ workspace/             # å·¥ä½œåŒºæ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ AGENTS.md
â”‚   â”‚   â”œâ”€â”€ SOUL.md
â”‚   â”‚   â”œâ”€â”€ USER.md
â”‚   â”‚   â””â”€â”€ TOOLS.md
â”‚   â”‚   â””â”€â”€ memory/
â”‚   â”‚       â””â”€â”€ MEMORY.md
â”‚   â””â”€â”€ skills/               # å†…ç½®æŠ€èƒ½
â”‚       â”œâ”€â”€ weather/
â”‚       â”œâ”€â”€ github/
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ fixtures/                # æµ‹è¯•æ•°æ®
â”‚
â”œâ”€â”€ docs/                        # æ–‡æ¡£
â”‚   â”œâ”€â”€ PRD.md                  # æœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ DEVELOPMENT-PLAN.md      # å¼€å‘è®¡åˆ’
â”‚   â”œâ”€â”€ API.md                  # API æ–‡æ¡£
â”‚   â””â”€â”€ ARCHITECTURE.md         # æ¶æ„è¯¦è§£
â”‚
â”œâ”€â”€ .eslintrc.js                # ESLint é…ç½®
â”œâ”€â”€ .prettierrc.json            # Prettier é…ç½®
â”œâ”€â”€ vitest.config.ts             # Vitest é…ç½®
â”œâ”€â”€ tsconfig.json               # TypeScript é…ç½®
â”œâ”€â”€ package.json
â”œâ”€â”€ tsup.config.ts              # æ‰“åŒ…é…ç½® (tsup)
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ README.md
```

---

## 5. å¼€å‘è®¡åˆ’ (Roadmap)

### Phase 1: MVP (ç¬¬ 1-2 å‘¨)

**ç›®æ ‡**: åŸºç¡€æ¡†æ¶å’Œå•ä¸ªæ¸ é“

- [x] é¡¹ç›®ç»“æ„è®¾è®¡
- [ ] æ¶ˆæ¯æ€»çº¿å®ç°
- [ ] Agent Loop åŸºç¡€ç‰ˆæœ¬
- [ ] å·¥å…·ç³»ç»Ÿæ¡†æ¶
- [ ] é…ç½®ç³»ç»Ÿï¼ˆZod Schemaï¼‰
- [ ] CLI æ¸ é“
- [ ] å•å…ƒæµ‹è¯•æ¡†æ¶
- [ ] åŸºç¡€æµ‹è¯•

### Phase 2: æ¸ é“å®ç° (ç¬¬ 3-5 å‘¨)

**ç›®æ ‡**: æ”¯æŒå››ä¸ªç›®æ ‡èŠå¤©å¹³å°

- [ ] WhatsApp æ¸ é“ï¼ˆBaileysï¼‰
- [ ] Feishu æ¸ é“ï¼ˆ@larksuiteoapi/node-sdkï¼‰
- [ ] Email æ¸ é“ï¼ˆimapflow + nodemailerï¼‰
- [ ] æ¸ é“ç®¡ç†å™¨
- [ ] ä¼šè¯ç®¡ç†
- [ ] å†…å­˜ç³»ç»Ÿ
- [ ] é›†æˆæµ‹è¯•

### Phase 3: ç”Ÿäº§å°±ç»ª (ç¬¬ 6-7 å‘¨)

**ç›®æ ‡**: ç¨³å®šæ€§ã€æ–‡æ¡£ã€éƒ¨ç½²

- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] å®Œæ•´æ–‡æ¡£
- [ ] Docker é•œåƒ
- [ ] éƒ¨ç½²æŒ‡å—
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] æ—¥å¿—å’Œç›‘æ§

### Phase 4: å¢å¼ºåŠŸèƒ½ (å¯é€‰)

**ç›®æ ‡**: é«˜çº§åŠŸèƒ½

- [ ] MCP æ”¯æŒ
- [ ] å®šæ—¶ä»»åŠ¡ (Cron)
- [ ] å¿ƒè·³æœºåˆ¶
- [ ] å­ä»£ç†ç³»ç»Ÿ
- [ ] æŠ€èƒ½ç³»ç»Ÿå®Œå–„
- [ ] æ›´å¤š LLM æä¾›å•†

---

## 6. API æ¦‚è§ˆ

### 6.1 Agent Loop API

```typescript
// åˆ›å»º Agent
const agent = new AgentLoop({
  bus: messageBus,
  provider: llmProvider,
  workspace: '~/.nanobot/workspace',
  model: 'openai:gpt-4o',
  maxIterations: 40,
  temperature: 0.1,
  memoryWindow: 100,
});

// å¯åŠ¨ä¸»å¾ªç¯ (æŒç»­å¤„ç†æ¶ˆæ¯)
await agent.run();

// å•æ¬¡å¤„ç† (CLI æ¨¡å¼)
const response = await agent.process({
  channel: 'cli',
  senderId: 'user',
  chatId: 'direct',
  content: 'Hello',
});

// åœæ­¢
agent.stop();
```

### 6.2 Tool API

```typescript
// å®ç°è‡ªå®šä¹‰å·¥å…·
class CustomTool extends Tool {
  name = 'custom_tool';

  description = 'This is a custom tool';

  parameters = {
    type: 'object',
    properties: {
      arg: {
        type: 'string',
        description: 'Argument for the tool',
      },
    },
    required: ['arg'],
  };

  async execute(params: { arg: string }): Promise<string> {
    return `Processed: ${params.arg}`;
  }
}

// æ³¨å†Œå·¥å…·
toolRegistry.register(new CustomTool());

// æ‰§è¡Œå·¥å…·
const result = await toolRegistry.execute('custom_tool', { arg: 'value' });
```

### 6.3 Channel API

```typescript
// å®ç°è‡ªå®šä¹‰æ¸ é“
class CustomChannel extends BaseChannel {
  async start(): Promise<void> {
    // è¿æ¥åˆ°å¹³å°
  }

  async stop(): Promise<void> {
    // æ–­å¼€è¿æ¥
  }

  async send(msg: OutboundMessage): Promise<void> {
    // å‘é€æ¶ˆæ¯åˆ°å¹³å°
  }
}

// æ³¨å†Œæ¸ é“ï¼ˆè‡ªåŠ¨ï¼‰
// ChannelManager ä¼šæ ¹æ®é…ç½®è‡ªåŠ¨åŠ è½½
```

### 6.4 Provider API

```typescript
// ä½¿ç”¨ @ai-sdk åˆ›å»º provider
import { createOpenAI } from '@ai-sdk/openai';
import { anthropic } from '@ai-sdk/anthropic';

// OpenAI Provider
const openaiProvider = createOpenAI({
  apiKey: config.providers.openai.apiKey,
  baseURL: config.providers.openai.apiBase,
});

// Anthropic Provider
const anthropicProvider = anthropic({
  apiKey: config.providers.anthropic.apiKey,
});

// ç»Ÿä¸€çš„è°ƒç”¨æ¥å£
const result = await streamText({
  model: openai('gpt-4o'),
  messages: [{ role: 'user', content: 'Hello' }],
  tools: toolDefinitions,
});
```

---

## 7. é…ç½®ç¤ºä¾‹

### 7.1 config.json

```json
{
  "agents": {
    "defaults": {
      "model": "openai:gpt-4o",
      "temperature": 0.1,
      "maxTokens": 8192,
      "maxIterations": 40,
      "memoryWindow": 100,
      "workspace": "~/.nanobot/workspace"
    }
  },
  "providers": {
    "openai": {
      "apiKey": "sk-...",
      "apiBase": "https://api.openai.com/v1"
    },
    "anthropic": {
      "apiKey": "sk-ant-..."
    },
    "openrouter": {
      "apiKey": "sk-or-...",
      "apiBase": "https://openrouter.ai/api/v1"
    }
  },
  "channels": {
    "whatsapp": {
      "enabled": true,
      "allowFrom": ["+1234567890"]
    },
    "feishu": {
      "enabled": true,
      "appId": "cli_xxx",
      "appSecret": "xxx",
      "encryptKey": "",
      "verificationToken": "",
      "allowFrom": []
    },
    "email": {
      "enabled": true,
      "imapHost": "imap.gmail.com",
      "imapPort": 993,
      "imapUsername": "bot@gmail.com",
      "imapPassword": "app-password",
      "smtpHost": "smtp.gmail.com",
      "smtpPort": 587,
      "smtpUsername": "bot@gmail.com",
      "smtpPassword": "app-password",
      "fromAddress": "bot@gmail.com",
      "allowFrom": ["user@example.com"]
    },
  },
  "tools": {
    "restrictToWorkspace": false,
    "web": {
      "search": {
        "apiKey": "..."
      }
    },
    "exec": {
      "timeout": 60,
      "allowedCommands": ["ls", "cat", "grep"]
    }
  }
}
```

---

## 8. æŠ€æœ¯å†³ç­–è¯´æ˜

### 8.1 ä¸ºä»€ä¹ˆé€‰æ‹© @ai-sdkï¼Ÿ

- **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰ LLM æä¾›å•†ä½¿ç”¨ç›¸åŒçš„ API
- **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- **æµå¼æ”¯æŒ**ï¼šå†…ç½®æµå¼å“åº”å¤„ç†
- **å¹¿æ³›æ”¯æŒ**ï¼šOpenAI, Anthropic, Google, Mistral, OpenRouter ç­‰
- **è½»é‡çº§**ï¼šæ— é¢å¤–æŠ½è±¡å±‚ï¼Œç›´æ¥æ˜ å°„åˆ°æä¾›å•† API
- **æ´»è·ƒç»´æŠ¤**ï¼šVercel å›¢é˜ŸæŒç»­æ›´æ–°

### 8.2 ä¸ºä»€ä¹ˆé€‰æ‹© Pino ä½œä¸ºæ—¥å¿—åº“ï¼Ÿ

- **é«˜æ€§èƒ½**ï¼šæ¯” winston å’Œ bunyan å¿«å¾—å¤š
- **JSON è¾“å‡º**ï¼šé€‚åˆç”Ÿäº§ç¯å¢ƒæ—¥å¿—æ”¶é›†
- **å­æ—¥å¿—**ï¼šæ”¯æŒåˆ›å»ºå¸¦é¢å¤–ä¸Šä¸‹æ–‡çš„å­ logger
- **é›¶ä¾èµ–**ï¼šæœ€å°åŒ–ä¾èµ–ä½“ç§¯
- **ç”Ÿäº§å°±ç»ª**ï¼šè¢«å¹¿æ³›ä½¿ç”¨å’ŒéªŒè¯

### 8.3 ä¸ºä»€ä¹ˆä½¿ç”¨ Zod è¿›è¡Œé…ç½®éªŒè¯ï¼Ÿ

- **ç±»å‹æ¨æ–­**ï¼šè‡ªåŠ¨ç”Ÿæˆ TypeScript ç±»å‹
- **è¿è¡Œæ—¶éªŒè¯**ï¼šé…ç½®æ–‡ä»¶åŠ è½½æ—¶éªŒè¯
- **å‹å¥½é”™è¯¯**ï¼šæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- **ç»„åˆæ€§**ï¼šæ”¯æŒå¤æ‚çš„ Schema ç»„åˆ
- **æ— ä¾èµ–**ï¼šé›¶è¿è¡Œæ—¶ä¾èµ–

### 8.4 ä¸ºä»€ä¹ˆé€‰æ‹© Vitest ä½œä¸ºæµ‹è¯•æ¡†æ¶ï¼Ÿ

- **Vite ç”Ÿæ€**ï¼šä¸é¡¹ç›®æ„å»ºå·¥å…·ä¸€è‡´
- **å¿«é€Ÿæ‰§è¡Œ**ï¼šä½¿ç”¨ Vite çš„ä¼˜åŒ–
- **ESM åŸç”Ÿ**ï¼šåŸç”Ÿæ”¯æŒ ES Modules
- **å†…è”å¿«ç…§**ï¼šå†…ç½®å¿«ç…§æµ‹è¯•
- **UI ç•Œé¢**ï¼šå¯é€‰çš„å¯è§†åŒ–æµ‹è¯•ç•Œé¢

---

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 å…³é”®æµ‹è¯•ç”¨ä¾‹

| æ¨¡å—           | ç”¨ä¾‹                                   |
|----------------|----------------------------------------|
| MessageBus     | æ¶ˆæ¯å…¥é˜Ÿã€å‡ºé˜Ÿã€å¹¶å‘                   |
| AgentLoop      | å•è½®å¯¹è¯ã€å¤šè½®å¯¹è¯ã€å·¥å…·è°ƒç”¨           |
| ToolRegistry   | å·¥å…·æ³¨å†Œã€æ‰§è¡Œã€é”™è¯¯å¤„ç†               |
| Channels       | æ¶ˆæ¯å‘é€ã€æ¥æ”¶ã€æ ¼å¼åŒ–                 |
| SessionManager | ä¼šè¯ä¿å­˜/åŠ è½½ã€å¹¶å‘                    |
| MemoryStore    | è®°å¿†æ•´åˆã€å½’æ¡£                       |
| Provider      | API è°ƒç”¨ã€é”™è¯¯é‡è¯•ã€æµå¼å“åº”         |

### 9.2 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å—                    | ç›®æ ‡è¦†ç›– | ä¼˜å…ˆçº§   |
|-------------------------|----------|----------|
| æ ¸å¿ƒ (agent, bus)        | 90%      | ğŸ”´ é«˜    |
| å·¥å…·å®ç°                | 80%      | ğŸŸ¡ ä¸­    |
| æ¸ é“å®ç°                | 70%      | ğŸŸ¢ ä½    |
| é…ç½®å’Œå·¥å…·å‡½æ•°          | 80%      | ğŸŸ¡ ä¸­    |
| LLM Provider            | 85%      | ğŸ”´ é«˜    |

---

## 10. å®šä¹‰å’Œæœ¯è¯­

| æœ¯è¯­         | å®šä¹‰                                   |
|--------------|----------------------------------------|
| Agent        | AI ä»£ç†ï¼Œé©±åŠ¨æ•´ä¸ªå¯¹è¯æµç¨‹              |
| Channel      | èŠå¤©å¹³å°é›†æˆ (WhatsApp, Feishu ç­‰)  |
| Tool         | Agent å¯ä»¥è°ƒç”¨çš„å·¥å…·/å‡½æ•°              |
| Session      | ç”¨æˆ·çš„ç‹¬ç«‹å¯¹è¯ä¼šè¯                     |
| Message Bus  | å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ                       |
| Provider     | LLM æœåŠ¡æä¾›å•†                         |
| Context      | ä¸º LLM æ„å»ºçš„å®Œæ•´æç¤ºè¯                |
| Workspace    | nanobot å·¥ä½œç›®å½• (~/.nanobot/workspace) |
| Skill        | å¯é‡ç”¨çš„ Agent åŠŸèƒ½æ¨¡å—                 |

---

## é™„å½•: å‘½ä»¤è¡Œæ¥å£

```bash
# åˆå§‹åŒ–
nanobot init

# å¯åŠ¨ç½‘å…³ (æŒç»­è¿è¡Œ,è¿æ¥æ‰€æœ‰æ¸ é“)
nanobot gateway --port 18790

# å•æ¬¡äº¤äº’
nanobot chat "è¯·å¸®æˆ‘å†™ä¸ª Python å‡½æ•°"

# äº¤äº’æ¨¡å¼
nanobot chat --interactive

# æŸ¥çœ‹çŠ¶æ€
nanobot status

# ç®¡ç†ä¼šè¯
nanobot session list
nanobot session clear <id>

# ç®¡ç†é…ç½®
nanobot config set agents.defaults.model openai:gpt-4o
nanobot config get

# æ¸ é“ç®¡ç†
nanobot channels status

# æŸ¥çœ‹æ—¥å¿—
nanobot logs --tail 100
```
